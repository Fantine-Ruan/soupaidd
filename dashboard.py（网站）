# æ”¾åœ¨æ–‡ä»¶ç¬¬ä¸€è¡Œ
import sys
class DummyStdin:
    def readline(self): 
        return "2024-01-01\n"  # æ¬ºéª— input() å‡½æ•°

sys.stdin = DummyStdin()  # é˜²æ­¢ input() å¡æ­»


import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from collections import defaultdict
import os

# é¡µé¢é…ç½®ï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼‰
st.set_page_config(
    page_title="SoupAIDD æ™ºèƒ½ç…²æ±¤å¤§è„‘",
    page_icon="ğŸ²",
    layout="wide",
    initial_sidebar_state="expanded"
)

# åŠ è½½æ•°æ®
current_folder = os.path.dirname(os.path.abspath(__file__))
df = pd.read_csv(os.path.join(current_folder, 'history_cleaned.csv'))

# ä¾§è¾¹æ æ§åˆ¶
st.sidebar.title("ğŸ›ï¸ æ§åˆ¶é¢æ¿")
st.sidebar.markdown("---")

# æ±¤å“ç­›é€‰
selected_soups = st.sidebar.multiselect(
    "ğŸ“Š é€‰æ‹©è¦åˆ†æçš„æ±¤å“",
    df['æ±¤å'].unique(),
    default=df['æ±¤å'].unique()
)

# æ—¥æœŸèŒƒå›´ç­›é€‰ï¼ˆå¦‚æœæœ‰æ—¥æœŸåˆ—ï¼‰
if 'æœˆä»½' in df.columns:
    selected_months = st.sidebar.slider(
        "ğŸ“… é€‰æ‹©æœˆä»½èŒƒå›´",
        int(df['æœˆä»½'].min()),
        int(df['æœˆä»½'].max()),
        (int(df['æœˆä»½'].min()), int(df['æœˆä»½'].max()))
    )
    # ç­›é€‰æ•°æ®
    mask = (df['æ±¤å'].isin(selected_soups)) & (df['æœˆä»½'] >= selected_months[0]) & (df['æœˆä»½'] <= selected_months[1])
else:
    mask = df['æ±¤å'].isin(selected_soups)

filtered_df = df[mask]

# ä¸»æ ‡é¢˜
st.title("ğŸ² SoupAIDD å®¶åº­ç…²æ±¤æ•°æ®é©¾é©¶èˆ±")
st.markdown("### åŸºäºéšæœºæ£®æ—AIçš„æ™ºèƒ½è†³é£Ÿåˆ†æä¸æ¨èç³»ç»Ÿ")
st.markdown("---")

# é¡¶éƒ¨æŒ‡æ ‡å¡ï¼ˆ4åˆ—å¸ƒå±€ï¼‰
col1, col2, col3, col4 = st.columns(4)

with col1:
    st.metric(
        label="ğŸ¥£ æ€»ç…²æ±¤æ¬¡æ•°", 
        value=f"{len(filtered_df)}æ¬¡",
        delta=f"å æ¯”{len(filtered_df)/len(df)*100:.0f}%" if len(filtered_df) != len(df) else "å…¨éƒ¨æ•°æ®"
    )

with col2:
    avg_score = filtered_df['åé¦ˆåˆ†æ•°'].mean() if len(filtered_df) > 0 else 0
    st.metric(
        label="â­ å¹³å‡æ»¡æ„åº¦", 
        value=f"{avg_score:.1f}åˆ†",
        delta=f"{avg_score-75:+.1f} vs æ ‡å‡†" if avg_score > 0 else "æ— æ•°æ®"
    )

with col3:
    if len(filtered_df) > 0:
        top_soup = filtered_df['æ±¤å'].value_counts().index[0]
        top_count = filtered_df['æ±¤å'].value_counts().iloc[0]
        st.metric(
            label="ğŸ† æ‹›ç‰Œæ±¤å“", 
            value=f"{top_soup}",
            delta=f"å‡ºç°{top_count}æ¬¡"
        )
    else:
        st.metric(label="ğŸ† æ‹›ç‰Œæ±¤å“", value="æ— æ•°æ®")

with col4:
    if len(filtered_df) > 0:
        weekend_rate = filtered_df['æ˜¯å¦å‘¨æœ«'].mean() * 100
        st.metric(
            label="ğŸ“… å‘¨æœ«ç…²æ±¤ç‡", 
            value=f"{weekend_rate:.0f}%",
            delta="å‘¨æœ«åå¥½" if weekend_rate > 50 else "å¹³æ—¥ä¸ºä¸»"
        )
    else:
        st.metric(label="ğŸ“… å‘¨æœ«ç…²æ±¤ç‡", value="0%")

st.markdown("---")

# ç¬¬ä¸€è¡Œï¼šä¸»åˆ†æåŒºï¼ˆå·¦2/3ï¼‰+ æ™ºèƒ½æ¨èï¼ˆå³1/3ï¼‰
left_col, right_col = st.columns([2, 1])

with left_col:
    st.subheader("ğŸ“ˆ æ±¤å“æ»¡æ„åº¦åˆ†å¸ƒåˆ†æ")
    
    if len(filtered_df) > 0:
        # ç®±çº¿å›¾
        fig = px.box(
            filtered_df, 
            x='æ±¤å', 
            y='åé¦ˆåˆ†æ•°', 
            color='æ±¤å',
            title="ä¸åŒæ±¤å“çš„æ»¡æ„åº¦ç¨³å®šæ€§ä¸åˆ†å¸ƒ",
            labels={'åé¦ˆåˆ†æ•°': 'æ»¡æ„åº¦è¯„åˆ† (0-100)', 'æ±¤å': 'æ±¤å“åç§°'},
            points="all"  # æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ç‚¹
        )
        fig.update_layout(
            showlegend=False,
            height=400,
            xaxis_tickangle=-45
        )
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.warning("âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ±¤å“è¿›è¡Œåˆ†æ")

with right_col:
    st.subheader("ğŸ¯ AIæ™ºèƒ½æ¨è")
    
    if len(filtered_df) > 0:
        # æ‰¾å‡ºè¯„åˆ†æœ€é«˜çš„æ±¤
        best_soup = filtered_df.groupby('æ±¤å')['åé¦ˆåˆ†æ•°'].mean().idxmax()
        best_score = filtered_df.groupby('æ±¤å')['åé¦ˆåˆ†æ•°'].mean().max()
        best_temp = filtered_df[filtered_df['æ±¤å']==best_soup]['æ¸©åº¦'].mean()
        
        # æ¨èå¡ç‰‡
        st.success(f"**æ˜æ—¥æ¨èï¼š{best_soup}**")
        st.write(f"**å†å²è¯„åˆ†ï¼š** {best_score:.1f}/100")
        st.write(f"**é€‚å®œæ¸©åº¦ï¼š** {best_temp:.1f}Â°C")
        
        # æŸ¥çœ‹é£Ÿæ
        ing_cols = [c for c in filtered_df.columns if c.startswith('é£Ÿæ_')]
        main_ings = [c.replace('é£Ÿæ_', '') for c in ing_cols 
                     if filtered_df[filtered_df['æ±¤å']==best_soup][c].sum() > 0]
        
        if main_ings:
            st.info(f"**æ ¸å¿ƒé£Ÿæï¼š** {', '.join(main_ings[:5])}")
        
        # åŸºäºå¤©æ°”çš„å»ºè®®
        st.write("---")
        st.write("**ğŸ’¡ çƒ¹é¥ªå»ºè®®ï¼š**")
        if best_temp < 15:
            st.write("â€¢ å¤©æ°”è¾ƒå†·ï¼Œå»ºè®®å»¶é•¿ç…²ç…®æ—¶é—´ï¼ˆ>2å°æ—¶ï¼‰")
        elif best_temp > 28:
            st.write("â€¢ å¤©æ°”ç‚çƒ­ï¼Œå»ºè®®æ¸…æ·¡å¿«ç…®ï¼ˆ<1å°æ—¶ï¼‰")
        else:
            st.write("â€¢ æ¸©åº¦é€‚å®œï¼Œæ ‡å‡†çƒ¹åˆ¶ï¼ˆ1-1.5å°æ—¶ï¼‰")
            
        if filtered_df[filtered_df['æ±¤å']==best_soup]['æ˜¯å¦å‘¨æœ«'].mean() > 0.5:
            st.write("â€¢ é€‚åˆå‘¨æœ«æ…¢æ…¢ç…²")
        else:
            st.write("â€¢ å·¥ä½œæ—¥å¿«æ‰‹æ±¤")
    else:
        st.info("è¯·é€‰æ‹©æ±¤å“æŸ¥çœ‹æ¨è")

# ç¬¬äºŒè¡Œï¼šå¤šç»´åº¦åˆ†æï¼ˆæ ‡ç­¾é¡µï¼‰
st.markdown("---")
st.subheader("ğŸ” å¤šç»´åº¦æ·±åº¦åˆ†æ")

tab1, tab2, tab3 = st.tabs(["ğŸŒ¡ï¸ æ¸©åº¦è¶‹åŠ¿", "ğŸ“Š å­£èŠ‚è§„å¾‹", "ğŸ•¸ï¸ é£Ÿæå…³è”"])

with tab1:
    if len(filtered_df) > 0:
        fig = px.scatter(
            filtered_df, 
            x='æ¸©åº¦', 
            y='åé¦ˆåˆ†æ•°', 
            color='æ±¤å',
            size='æ˜¯å¦å‘¨æœ«',
            size_max=20,
            hover_data=['æ—¥æœŸ', 'å¤©æ°”'],
            trendline="ols",  # æ·»åŠ è¶‹åŠ¿çº¿
            title="æ¸©åº¦ä¸æ»¡æ„åº¦çš„ç›¸å…³æ€§åˆ†æï¼ˆæ°”æ³¡å¤§å°ä»£è¡¨æ˜¯å¦å‘¨æœ«ï¼‰",
            labels={'æ¸©åº¦': 'æ°”æ¸© (Â°C)', 'åé¦ˆåˆ†æ•°': 'æ»¡æ„åº¦ (0-100)'}
        )
        fig.update_layout(height=500)
        st.plotly_chart(fig, use_container_width=True)
        
        # æ˜¾ç¤ºç›¸å…³ç³»æ•°
        corr = filtered_df['æ¸©åº¦'].corr(filtered_df['åé¦ˆåˆ†æ•°'])
        st.caption(f"ğŸ“Š æ¸©åº¦ä¸æ»¡æ„åº¦çš„çš®å°”é€Šç›¸å…³ç³»æ•°ï¼š{corr:.3f}ï¼ˆ{'æ­£ç›¸å…³' if corr > 0 else 'è´Ÿç›¸å…³'}ï¼‰")
    else:
        st.warning("æ— æ•°æ®å¯ä¾›åˆ†æ")

with tab2:
    if len(filtered_df) > 0 and 'å­£èŠ‚ç¼–ç ' in filtered_df.columns:
        col_left, col_right = st.columns(2)
        
        with col_left:
            # æ—­æ—¥å›¾
            fig = px.sunburst(
                filtered_df, 
                path=['å­£èŠ‚ç¼–ç ', 'æ±¤å'], 
                values='åé¦ˆåˆ†æ•°',
                color='åé¦ˆåˆ†æ•°',
                color_continuous_scale='RdYlGn',
                title="å­£èŠ‚-æ±¤å“åå¥½åˆ†å¸ƒï¼ˆ1=æ˜¥, 2=å¤, 3=ç§‹, 4=å†¬ï¼‰"
            )
            fig.update_layout(height=500)
            st.plotly_chart(fig, use_container_width=True)
        
        with col_right:
            # å­£èŠ‚ç»Ÿè®¡è¡¨
            season_stats = filtered_df.groupby('å­£èŠ‚ç¼–ç ').agg({
                'æ±¤å': 'count',
                'åé¦ˆåˆ†æ•°': 'mean',
                'æ¸©åº¦': 'mean'
            }).round(1)
            season_stats.columns = ['ç…²æ±¤æ¬¡æ•°', 'å¹³å‡è¯„åˆ†', 'å¹³å‡æ¸©åº¦']
            season_stats.index = ['æ˜¥å­£', 'å¤å­£', 'ç§‹å­£', 'å†¬å­£']
            st.write("**å­£èŠ‚ç»Ÿè®¡è¡¨ï¼š**")
            st.dataframe(season_stats, use_container_width=True)
    else:
        st.warning("ç¼ºå°‘å­£èŠ‚æ•°æ®")

with tab3:
    st.subheader("é£Ÿæé…ä¼å…³è”åˆ†æ")
    
    # è®¡ç®—é£Ÿæå…±ç°
    ing_cols = [c for c in filtered_df.columns if c.startswith('é£Ÿæ_')]
    if len(ing_cols) > 0:
        cooccur = defaultdict(int)
        
        for _, row in filtered_df.iterrows():
            present_ings = [c.replace('é£Ÿæ_', '') for c in ing_cols if row[c] == 1]
            for i in range(len(present_ings)):
                for j in range(i+1, len(present_ings)):
                    pair = tuple(sorted([present_ings[i], present_ings[j]]))
                    cooccur[pair] += 1
        
        if cooccur:
            # å–Top 10
            top_pairs = sorted(cooccur.items(), key=lambda x: x[1], reverse=True)[:10]
            pairs_df = pd.DataFrame(
                [(f"{p[0]} + {p[1]}", c) for p, c in top_pairs], 
                columns=['é£Ÿæç»„åˆ', 'å…±ç°æ¬¡æ•°']
            )
            
            fig = px.bar(
                pairs_df, 
                x='å…±ç°æ¬¡æ•°', 
                y='é£Ÿæç»„åˆ', 
                orientation='h',
                color='å…±ç°æ¬¡æ•°',
                color_continuous_scale='Viridis',
                title="ç»å¸¸ä¸€èµ·å‡ºç°çš„é£Ÿæç»„åˆï¼ˆé…ä¼è§„å¾‹ï¼‰"
            )
            fig.update_layout(height=500, yaxis=dict(autorange="reversed"))
            st.plotly_chart(fig, use_container_width=True)
            
            st.caption("ğŸ’¡ æç¤ºï¼šè¿çº¿è¶Šç²—çš„é£Ÿæç»„åˆï¼Œè¯´æ˜å¦ˆå¦ˆè¶Šå–œæ¬¢ä¸€èµ·ç…²")
        else:
            st.info("å½“å‰ç­›é€‰æ¡ä»¶ä¸‹é£Ÿæå…±ç°æ•°æ®ä¸è¶³")
    else:
        st.warning("æœªæ‰¾åˆ°é£Ÿææ•°æ®åˆ—")

# ç¬¬ä¸‰è¡Œï¼šåŸå§‹æ•°æ®æŸ¥çœ‹ä¸å¯¼å‡º
st.markdown("---")
st.subheader("ğŸ“‹ åŸå§‹æ•°æ®æŸ¥çœ‹ä¸å¯¼å‡º")

# é€‰æ‹©è¦æ˜¾ç¤ºçš„åˆ—
display_cols = ['æ—¥æœŸ', 'æ±¤å', 'æ¸©åº¦', 'åé¦ˆåˆ†æ•°', 'å¤©æ°”', 'æ˜ŸæœŸ']
available_cols = [c for c in display_cols if c in filtered_df.columns]
if available_cols:
    st.dataframe(
        filtered_df[available_cols], 
        use_container_width=True,
        height=300
    )
    
    # ä¸‹è½½æŒ‰é’®
    csv = filtered_df.to_csv(index=False).encode('utf-8')
    st.download_button(
        label="ğŸ“¥ ä¸‹è½½å½“å‰ç­›é€‰æ•°æ®ä¸ºCSV",
        data=csv,
        file_name='filtered_soup_data.csv',
        mime='text/csv',
    )
else:
    st.write("æ•°æ®é¢„è§ˆ")

# åº•éƒ¨ä¿¡æ¯
st.markdown("---")
st.caption("ğŸ² Powered by SoupAIDD | ç»“åˆä¼ ç»Ÿä¸­åŒ»æ™ºæ…§ä¸ç°ä»£æœºå™¨å­¦ä¹  | æ•°æ®é©±åŠ¨çš„ç¾å‘³å†³ç­–æ”¯æŒç³»ç»Ÿ")